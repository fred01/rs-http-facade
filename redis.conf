# Redis Configuration for Production
# Maximum reliability and data persistence settings

# =============================================================================
# GENERAL
# =============================================================================

# Bind to all interfaces (change in production if needed)
bind 0.0.0.0

# Protected mode - disable when using authentication
protected-mode no

# Port
port 6379

# TCP backlog
tcp-backlog 511

# Timeout for idle connections (0 = disabled)
timeout 0

# TCP keepalive
tcp-keepalive 300

# =============================================================================
# SNAPSHOTTING (RDB)
# =============================================================================

# Save the DB on disk:
# save <seconds> <changes>
# Save after 900 sec (15 min) if at least 1 key changed
save 900 1
# Save after 300 sec (5 min) if at least 10 keys changed
save 300 10
# Save after 60 sec (1 min) if at least 10000 keys changed
save 60 10000

# Stop accepting writes if RDB save fails
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum
rdbchecksum yes

# Sanitize file name for RDB
sanitize-dump-payload clients

# The filename where to dump the DB
dbfilename dump.rdb

# Remove RDB files used by replication in instances without persistence enabled
rdb-del-sync-files no

# The working directory
dir /data

# =============================================================================
# APPEND ONLY MODE (AOF) - Maximum durability
# =============================================================================

# Enable AOF persistence
appendonly yes

# The name of the append only file
appendfilename "appendonly.aof"

# AOF fsync policy:
# - always: fsync after every write (slowest, safest)
# - everysec: fsync every second (good compromise)
# - no: let the OS flush when it wants (fastest, least safe)
appendfsync everysec

# Don't fsync during BGSAVE/BGREWRITEAOF
no-appendfsync-on-rewrite no

# Auto AOF rewrite
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF on startup
aof-load-truncated yes

# Use RDB preamble in AOF for faster loading
aof-use-rdb-preamble yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# =============================================================================
# MEMORY MANAGEMENT
# =============================================================================

# Max memory (adjust based on your available RAM)
# maxmemory 2gb

# Eviction policy when maxmemory is reached
# noeviction: return errors when memory limit is reached
# For streams, noeviction is recommended to avoid data loss
maxmemory-policy noeviction

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25
active-defrag-max-scan-fields 1000

# =============================================================================
# LAZY FREEING
# =============================================================================

# Async deletion settings
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
lazyfree-lazy-user-del no
lazyfree-lazy-user-flush no

# =============================================================================
# SLOW LOG
# =============================================================================

# Slow log threshold in microseconds (10ms)
slowlog-log-slower-than 10000

# Slow log length
slowlog-max-len 128

# =============================================================================
# LATENCY MONITOR
# =============================================================================

# Latency monitoring threshold (0 = disabled)
latency-monitor-threshold 100

# =============================================================================
# CLIENT OUTPUT BUFFER LIMITS
# =============================================================================

# Normal clients
client-output-buffer-limit normal 0 0 0

# Replica clients
client-output-buffer-limit replica 256mb 64mb 60

# Pub/Sub clients
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================================================
# STREAMS SPECIFIC
# =============================================================================

# Stream node max bytes (for memory efficiency)
stream-node-max-bytes 4096

# Stream node max entries
stream-node-max-entries 100

# =============================================================================
# LOGGING
# =============================================================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout (for Docker)
logfile ""

# =============================================================================
# SECURITY
# =============================================================================

# Require authentication (uncomment and set a strong password)
# requirepass your-strong-redis-password

# Disable dangerous commands in production
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command DEBUG ""
rename-command SHUTDOWN REDIS_SHUTDOWN
